<div class="min-h-screen bg-slate-900 text-slate-100 flex flex-col font-sans selection:bg-indigo-500 selection:text-white">
  
  <!-- Header -->
  <header class="w-full bg-slate-900 border-b border-slate-800 sticky top-0 z-20 backdrop-blur-md bg-opacity-80">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-2 cursor-pointer" (click)="viewMode.set('generator')">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500"></div>
        <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-purple-400 hidden sm:block">
          ChromaGen AI
        </h1>
      </div>

      <div class="flex items-center gap-4">
        <!-- View Toggle -->
        @if (authService.currentUser()) {
          <div class="flex bg-slate-800 rounded-lg p-1 border border-slate-700">
            <button 
              (click)="viewMode.set('generator')"
              class="px-3 py-1.5 rounded-md text-sm font-medium transition-all"
              [class.bg-slate-700]="viewMode() === 'generator'"
              [class.text-white]="viewMode() === 'generator'"
              [class.text-slate-400]="viewMode() !== 'generator'"
            >Generator</button>
            <button 
              (click)="viewMode.set('profile')"
              class="px-3 py-1.5 rounded-md text-sm font-medium transition-all"
              [class.bg-slate-700]="viewMode() === 'profile'"
              [class.text-white]="viewMode() === 'profile'"
              [class.text-slate-400]="viewMode() !== 'profile'"
            >Profile</button>
          </div>
        }

        <!-- User Auth -->
        @if (authService.currentUser()) {
          <div class="flex items-center gap-3">
            <span class="text-sm text-slate-400 hidden sm:inline">Hi, {{ authService.currentUser()?.username }}</span>
            <button (click)="authService.logout()" class="text-sm text-slate-400 hover:text-white underline">Logout</button>
          </div>
        } @else {
          <button 
            (click)="showAuthModal.set(true)"
            class="text-sm font-medium bg-slate-800 hover:bg-slate-700 border border-slate-700 px-4 py-2 rounded-lg transition-colors"
          >
            Login / Sign Up
          </button>
        }
      </div>
    </div>
  </header>

  <main class="flex-grow w-full max-w-6xl mx-auto px-4 py-8 flex flex-col gap-8">
    
    <!-- AUTH MODAL -->
    @if (showAuthModal()) {
      <app-auth-modal 
        (close)="showAuthModal.set(false)"
        (submit)="handleAuthSubmit($event)"
      ></app-auth-modal>
    }

    <!-- PROFILE VIEW -->
    @if (viewMode() === 'profile') {
      <div class="space-y-6 animate-fade-in">
        <h2 class="text-3xl font-bold text-white">Your Saved Palettes</h2>
        @if (!authService.currentUser()?.savedPalettes?.length) {
          <div class="text-center py-20 text-slate-500 border border-dashed border-slate-800 rounded-xl">
            <p>No saved palettes yet.</p>
            <button (click)="viewMode.set('generator')" class="text-indigo-400 mt-2 hover:underline">Go create some!</button>
          </div>
        } @else {
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
             @for (palette of authService.currentUser()?.savedPalettes; track palette.id; let i = $index) {
               <div 
                  class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden hover:border-indigo-500/50 transition-all shadow-lg group animate-fade-in"
                  [style.animation-delay]="i * 50 + 'ms'"
                >
                 <div class="h-24 flex">
                   @for (c of palette.colors; track c.hex) {
                     <div class="h-full flex-grow" [style.background-color]="c.hex"></div>
                   }
                 </div>
                 <div class="p-4">
                   <h3 class="font-bold text-lg text-white mb-1">{{ palette.paletteName }}</h3>
                   <p class="text-xs text-slate-400 line-clamp-2 mb-4">{{ palette.description }}</p>
                   <div class="flex gap-2">
                     <button (click)="loadSavedPalette(palette)" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded text-sm font-medium transition-colors">Load</button>
                     <button (click)="authService.removePalette(palette.id)" class="px-3 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded transition-colors" title="Remove">
                       <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                     </button>
                   </div>
                 </div>
               </div>
             }
          </div>
        }
      </div>
    }

    <!-- GENERATOR VIEW -->
    @if (viewMode() === 'generator') {
      <!-- Hero / Input Section -->
      @if (!currentPalette() && variations().length === 0) {
        <section class="max-w-3xl mx-auto w-full text-center space-y-6 animate-fade-in">
          <div class="space-y-2">
            <h2 class="text-3xl md:text-5xl font-extrabold tracking-tight">
              Generate <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400">Perfect Harmony</span>
            </h2>
            <p class="text-slate-400 text-lg">
              Describe a mood or enter a Hex code (e.g. #FF5733) to get 4 distinct styles.
            </p>
          </div>
        </section>
      }

      <div class="max-w-3xl mx-auto w-full relative group z-10">
        <div class="absolute -inset-1 bg-gradient-to-r from-indigo-500 to-pink-500 rounded-xl blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>
        <div class="relative flex items-center bg-slate-800 rounded-xl p-1 shadow-2xl border border-slate-700">
          <input 
            type="text" 
            [(ngModel)]="prompt" 
            (keyup.enter)="generate()"
            placeholder="Describe a mood or enter a Hex color (e.g., #5D3FD3)" 
            class="flex-grow bg-transparent border-none outline-none text-white placeholder-slate-500 px-4 py-3 text-lg rounded-xl focus:ring-0"
            [disabled]="isLoading()"
          >
          <button 
            (click)="generate()" 
            [disabled]="isLoading() || !prompt().trim()"
            class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-3 rounded-lg font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
          >
            @if (isLoading()) {
              <span>Generating...</span>
            } @else {
              <span>Generate</span>
            }
          </button>
        </div>
      </div>

      @if (!currentPalette() && variations().length === 0) {
        <!-- Suggestions -->
        <div class="flex flex-wrap justify-center gap-2 text-sm text-slate-500 max-w-2xl mx-auto">
          <span>Try:</span>
          <button (click)="prompt.set('#FF6B6B'); generate()" class="hover:text-red-400 underline decoration-red-500/30">#FF6B6B</button>
          <button (click)="prompt.set('#4ECDC4'); generate()" class="hover:text-teal-400 underline decoration-teal-500/30">#4ECDC4</button>
          <button (click)="prompt.set('Neon Tokyo Night'); generate()" class="hover:text-indigo-400 underline decoration-indigo-500/30">Neon Tokyo</button>
        </div>
      }

      <!-- Error Message -->
      @if (error()) {
        <div class="p-4 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400 text-center max-w-2xl mx-auto">
          {{ error() }}
        </div>
      }

      <!-- Loading State -->
      @if (isLoading()) {
        <div class="flex justify-center py-12">
          <app-loader></app-loader>
        </div>
      }

      <!-- VARIATIONS VIEW (For Hex Input) -->
      @if (variations().length > 0 && !currentPalette()) {
        <div class="space-y-6 mt-4">
          <h3 class="text-2xl font-bold text-center text-white animate-fade-in">Select a Style for {{ prompt() }}</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            @for (p of variations(); track p.id; let i = $index) {
              <div 
                (click)="selectVariation(p)"
                class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden hover:ring-2 hover:ring-indigo-500 hover:scale-[1.02] transition-all cursor-pointer shadow-lg group animate-fade-in"
                [style.animation-delay]="i * 150 + 'ms'"
              >
                <!-- Preview Strip -->
                <div class="h-32 flex">
                  @for (c of p.colors; track c.hex) {
                    <div class="h-full flex-grow" [style.background-color]="c.hex"></div>
                  }
                </div>
                
                <div class="p-5">
                   <div class="flex justify-between items-center mb-2">
                     <h4 class="font-bold text-xl text-white group-hover:text-indigo-400 transition-colors">{{ p.paletteName }}</h4>
                     <span class="text-xs bg-slate-700 text-slate-300 px-2 py-1 rounded-full border border-slate-600">Select</span>
                   </div>
                   <p class="text-sm text-slate-400 line-clamp-2">{{ p.description }}</p>
                </div>
              </div>
            }
          </div>
        </div>
      }

      <!-- SINGLE PALETTE VIEW -->
      @if (currentPalette() && !isLoading()) {
        <div class="space-y-8 animate-fade-in">
          
          <!-- Palette Toolbar -->
          <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 border-b border-slate-800 pb-6">
            <div class="space-y-1">
              @if (variations().length > 0) {
                 <button (click)="backToVariations()" class="text-sm text-indigo-400 hover:text-indigo-300 mb-2 flex items-center gap-1">
                   <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg>
                   Back to styles
                 </button>
              }
              <h2 class="text-3xl font-bold text-white">{{ currentPalette()?.paletteName }}</h2>
              <p class="text-slate-400 max-w-xl">{{ currentPalette()?.description }}</p>
            </div>
            
            <div class="flex flex-wrap gap-2">
              <button 
                (click)="generate()"
                class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-indigo-300 bg-indigo-900/20 hover:bg-indigo-900/40 rounded-lg transition-colors border border-indigo-900/30"
                title="Regenerate palette"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>
                Regenerate
              </button>

              <button 
                (click)="generateAntiPalette()"
                class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-red-300 bg-red-900/20 hover:bg-red-900/40 rounded-lg transition-colors border border-red-900/30"
                title="Generate 'Disliked' colors based on DeltaE logic"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19.42 16.18a2 2 0 0 0 2.16-1.52l1.32-4.84a2 2 0 0 0-1.2-2.37l-2.65-.9a2 2 0 0 0-2.1.34l-1.34.95a2 2 0 0 1-2.22.09l-3.3-2.18a2 2 0 0 0-2.14 0l-3.3 2.18a2 2 0 0 1-2.23-.1l-1.34-.94a2 2 0 0 0-2.1-.35l-2.64.9a2 2 0 0 0-1.2 2.37l1.32 4.84a2 2 0 0 0 2.16 1.52l3.4.67a2 2 0 0 1 1.6 1.48l.43 2.13a2 2 0 0 0 3.92 0l.43-2.13a2 2 0 0 1 1.6-1.48Z"/></svg>
                Anti-Palette
              </button>

              <button 
                (click)="toggleSavePalette()"
                class="flex items-center gap-2 px-3 py-2 text-sm font-medium rounded-lg transition-colors border"
                [class.bg-indigo-600]="isCurrentSaved()"
                [class.border-indigo-600]="isCurrentSaved()"
                [class.text-white]="isCurrentSaved()"
                [class.bg-slate-800]="!isCurrentSaved()"
                [class.border-slate-700]="!isCurrentSaved()"
                [class.text-slate-300]="!isCurrentSaved()"
                [class.hover:bg-slate-700]="!isCurrentSaved()"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" [class.fill-current]="isCurrentSaved()" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
                {{ isCurrentSaved() ? 'Saved' : 'Save' }}
              </button>

              <button 
                (click)="sharePalette()"
                class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-slate-300 bg-slate-800 hover:bg-slate-700 rounded-lg transition-colors border border-slate-700"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
                Share
              </button>

              <div class="relative group">
                <button class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-slate-300 bg-slate-800 hover:bg-slate-700 rounded-lg transition-colors border border-slate-700">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                  Export
                </button>
                <div class="absolute right-0 mt-2 w-48 bg-slate-800 rounded-lg shadow-xl border border-slate-700 hidden group-hover:block z-50">
                   <button (click)="export('css')" class="block w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white first:rounded-t-lg">CSS Variables</button>
                   <button (click)="export('json')" class="block w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white">JSON Data</button>
                   <button (click)="export('png')" class="block w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white last:rounded-b-lg">PNG Image</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Color Grid -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
            @for (color of currentPalette()?.colors; track color.hex; let i = $index) {
              <div 
                class="group relative flex flex-col rounded-2xl overflow-hidden shadow-lg transition-transform hover:-translate-y-1 hover:shadow-xl bg-slate-800 border border-slate-700 animate-fade-in"
                [style.animation-delay]="i * 100 + 'ms'"
              >
                
                <!-- Color Swatch -->
                <div 
                  class="h-40 w-full relative cursor-pointer" 
                  [style.background-color]="color.hex"
                  (click)="copyToClipboard(color.hex)"
                >
                   <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                     <button 
                       (click)="$event.stopPropagation(); generateHarmony(color.hex)"
                       class="bg-black/50 hover:bg-black/70 backdrop-blur text-white text-xs px-2 py-1 rounded shadow"
                       title="Generate Harmony based on this color"
                     >
                       Harmony
                     </button>
                   </div>
                </div>

                <!-- Color Details -->
                <div class="p-4 flex flex-col gap-2 h-full justify-between">
                  <div>
                    <div class="flex items-center justify-between">
                      <h3 class="font-bold text-lg text-white truncate" [title]="color.name">{{ color.name }}</h3>
                      <button 
                        (click)="copyToClipboard(color.hex)"
                        class="text-slate-500 hover:text-white transition-colors"
                        title="Copy Hex"
                      >
                        <app-copy-icon></app-copy-icon>
                      </button>
                    </div>
                    <div class="flex flex-col gap-1 mt-1">
                      <p class="font-mono text-xs text-slate-400 uppercase tracking-wide cursor-pointer hover:text-indigo-400" (click)="copyToClipboard(color.hex)">{{ color.hex }}</p>
                      <p class="font-mono text-[10px] text-slate-600 hover:text-slate-400 cursor-pointer" (click)="copyToClipboard(color.rgb || '')">{{ color.rgb }}</p>
                    </div>
                  </div>
                  <p class="text-xs text-slate-500 leading-relaxed mt-2">{{ color.description }}</p>
                </div>
              </div>
            }
          </div>

          <!-- Palette Preview (Mock UI) -->
          <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700 animate-fade-in" style="animation-delay: 500ms">
            <h3 class="text-sm font-semibold text-slate-400 mb-4 uppercase tracking-wider">UI Preview</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <!-- Card Preview -->
              <div class="rounded-xl overflow-hidden shadow-lg bg-white" [style.background-color]="currentPalette()?.colors?.[0]?.hex">
                <div class="h-32 w-full" [style.background-color]="currentPalette()?.colors?.[1]?.hex"></div>
                <div class="p-6">
                  <div class="h-4 w-1/3 rounded mb-4 opacity-50" [style.background-color]="currentPalette()?.colors?.[2]?.hex"></div>
                  <div class="h-2 w-full rounded mb-2 opacity-30" [style.background-color]="currentPalette()?.colors?.[2]?.hex"></div>
                  <div class="h-2 w-2/3 rounded opacity-30" [style.background-color]="currentPalette()?.colors?.[2]?.hex"></div>
                  <div class="mt-6 flex gap-2">
                    <button class="px-4 py-2 rounded-lg text-sm font-bold shadow-sm"
                      [style.background-color]="currentPalette()?.colors?.[3]?.hex"
                      [style.color]="currentPalette()?.colors?.[3]?.textColor">
                      Action
                    </button>
                    <button class="px-4 py-2 rounded-lg text-sm font-bold opacity-80"
                       [style.background-color]="currentPalette()?.colors?.[4]?.hex || currentPalette()?.colors?.[1]?.hex"
                       [style.color]="currentPalette()?.colors?.[4]?.textColor || '#fff'">
                      Secondary
                    </button>
                  </div>
                </div>
              </div>

              <!-- Chart Preview -->
              <div class="flex flex-col justify-center items-center p-8 rounded-xl" [style.background-color]="'#1e293b'">
                <div class="flex items-end gap-4 h-40">
                  @for (color of currentPalette()?.colors; track color.hex; let i = $index) {
                     <div 
                      class="w-8 rounded-t-lg transition-all duration-500 hover:opacity-80"
                      [style.height.%]="40 + (i * 10)"
                      [style.background-color]="color.hex"
                     ></div>
                  }
                </div>
                <p class="mt-4 text-slate-400 text-sm">Data Visualization Example</p>
              </div>
            </div>
          </div>

        </div>
      }

      <!-- History Section -->
      @if (history().length > 0) {
        <section class="mt-12 border-t border-slate-800 pt-8 animate-fade-in">
          <h3 class="text-xl font-bold mb-6 text-slate-300">History</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            @for (item of history(); track item.palette.createdAt; let i = $index) {
              <div 
                (click)="loadFromHistory(item)"
                class="group cursor-pointer bg-slate-800 border border-slate-700 rounded-xl p-4 hover:border-indigo-500/50 transition-all hover:bg-slate-750"
              >
                <div class="flex justify-between items-start mb-3">
                  <h4 class="font-medium text-slate-200 group-hover:text-indigo-400 transition-colors truncate pr-2">{{ item.palette.paletteName }}</h4>
                  <button 
                    (click)="deleteHistoryItem($event, i)"
                    class="text-slate-600 hover:text-red-400 p-1 rounded-md hover:bg-red-400/10 transition-colors"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                  </button>
                </div>
                
                <div class="flex h-8 rounded-lg overflow-hidden w-full">
                  @for (c of item.palette.colors; track c.hex) {
                    <div class="flex-grow h-full" [style.background-color]="c.hex"></div>
                  }
                </div>
                <p class="text-xs text-slate-500 mt-3 truncate">{{ item.prompt }}</p>
              </div>
            }
          </div>
        </section>
      }
    } <!-- End Generator View -->

  </main>

  <footer class="border-t border-slate-800 py-6 mt-8">
    <div class="text-center text-slate-500 text-sm">
      &copy; 2024 ChromaGen AI. Generated using Google Gemini API.
    </div>
  </footer>

  <!-- Toast Notification -->
  @if (toastMessage()) {
    <div class="fixed bottom-8 left-1/2 -translate-x-1/2 z-50 animate-fade-in-up">
      <div class="bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl border border-slate-700 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-emerald-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        {{ toastMessage() }}
      </div>
    </div>
  }

</div>

<!-- Styles for animations -->
<style>
  @keyframes fade-in {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fade-in {
    animation: fade-in 0.5s ease-out both;
  }
  
  @keyframes fade-in-up {
    from { opacity: 0; transform: translate(-50%, 20px); }
    to { opacity: 1; transform: translate(-50%, 0); }
  }
  .animate-fade-in-up {
    animation: fade-in-up 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
  }
</style>